<?xml version="1.0" encoding="UTF-8"?>
<workflow extends="common/process/workflow-base.xml">
  <metadata>
    <name>mobile-app-workflow</name>
    <description>모바일 앱 프로젝트용 워크플로우</description>
    <type>mobile-app</type>
    <version>1.0</version>
  </metadata>

  <!-- 레벨별 워크플로우 프리셋 -->
  <presets>
    <preset id="mvp" level="1" description="MVP - 빠른 개발">
      <phases include="planning,implementation,review,complete"/>
      <skip-phases>security</skip-phases>
      <simplified-rules>
        <rule>보안 검토 생략 가능 (Level 3 Enterprise에서 수행)</rule>
        <rule>UI/UX 명세 간소화 가능</rule>
        <rule>테스트 커버리지 60% 허용</rule>
        <rule>단일 플랫폼(Android 또는 iOS) 우선 가능</rule>
      </simplified-rules>
    </preset>

    <preset id="standard" level="2" description="표준 - 균형 잡힌 개발">
      <phases include="planning,implementation,review,complete"/>
      <optional-phases>security</optional-phases>
      <rules>
        <rule>UI/UX 명세 필수</rule>
        <rule>테스트 커버리지 80% 필수</rule>
        <rule>코드 리뷰 필수</rule>
        <rule>양 플랫폼 동작 확인 필수</rule>
      </rules>
    </preset>

    <preset id="enterprise" level="3" description="엔터프라이즈 - 완전한 프로세스">
      <phases include="planning,implementation,review,security,complete"/>
      <mandatory>
        <item>모든 Phase 통과 필수</item>
        <item>보안 검토 필수 (SSL pinning, obfuscation)</item>
        <item>테스트 커버리지 90% 필수</item>
        <item>접근성(a11y) 검증 필수</item>
      </mandatory>
    </preset>
  </presets>

  <!-- Mobile App 특화 Phase 확장 -->
  <phase-extensions>
    <!-- 기획 Phase 확장 -->
    <extend-phase id="planning">
      <additional-tasks>
        <task id="ui-ux">UI/UX 설계 (화면 플로우, 와이어프레임)</task>
        <task id="platform-spec">플랫폼 분기 정의 (iOS/Android 차이점)</task>
        <task id="data-model">데이터 모델 설계 (로컬 + 원격)</task>
      </additional-tasks>

      <additional-outputs>
        <output>ssot/ui-ux-spec.md</output>
      </additional-outputs>

      <agent-assignment>
        <task ref="ui-ux" agent="tsq-designer" fallback="tsq-planner"/>
        <task ref="platform-spec" agent="tsq-planner" mode="architect"/>
        <task ref="data-model" agent="tsq-planner" mode="architect"/>
      </agent-assignment>
    </extend-phase>

    <!-- 구현 Phase 확장: Feature/Core 분리 -->
    <extend-phase id="implementation">
      <parallel-tracks>
        <track id="feature" agent="tsq-developer">
          <description>Feature 단위 구현 (UI + 비즈니스 로직)</description>
          <prerequisites>
            <check>ssot/ui-ux-spec.md</check>
            <check>ssot/data-design.md</check>
          </prerequisites>
          <tasks>
            <task id="data-models">데이터 모델 구현 (freezed)</task>
            <task id="repositories">Repository 패턴 구현</task>
            <task id="state">상태 관리 (Riverpod Notifier)</task>
            <task id="ui">위젯/화면 구현</task>
          </tasks>
          <exit-criteria>
            <criterion>모든 화면 구현 완료</criterion>
            <criterion>위젯 테스트 통과</criterion>
            <criterion>상태 관리 단위 테스트 통과</criterion>
          </exit-criteria>
        </track>

        <track id="core" agent="tsq-developer">
          <description>Core 서비스 (인증, 네트워킹, 푸시 등)</description>
          <prerequisites>
            <check>ssot/service-spec.md</check>
          </prerequisites>
          <tasks>
            <task id="auth">인증/인가 구현</task>
            <task id="networking">API 클라이언트 구현 (Dio)</task>
            <task id="push">푸시 알림 설정 (FCM)</task>
            <task id="local-db">로컬 DB 구현 (Drift/Hive)</task>
          </tasks>
          <exit-criteria>
            <criterion>API 클라이언트 테스트 통과</criterion>
            <criterion>인증 플로우 검증</criterion>
            <criterion>오프라인 모드 기본 동작</criterion>
          </exit-criteria>
        </track>

        <track id="integration" depends-on="feature,core">
          <description>통합 테스트</description>
          <tasks>
            <task id="integration-test">Integration 테스트</task>
            <task id="platform-test">플랫폼별 테스트 (iOS/Android)</task>
          </tasks>
        </track>
      </parallel-tracks>

      <!-- 방법론별 변형 -->
      <methodology-variants>
        <variant methodology="tdd">
          <task-order>test → implement → refactor</task-order>
          <enforcement>테스트 없이 구현 코드 PR 금지</enforcement>
        </variant>
      </methodology-variants>
    </extend-phase>

    <!-- 검증 Phase 확장 -->
    <extend-phase id="review">
      <additional-checklists>
        <checklist name="모바일 성능">
          <item>프레임 드랍 없음 (60fps 유지)</item>
          <item>앱 크기 합리적 (&lt; 50MB release)</item>
          <item>메모리 릭 없음 (DevTools 확인)</item>
          <item>오프라인 처리 정상 동작</item>
          <item>Cold start 시간 &lt; 3s</item>
        </checklist>

        <checklist name="플랫폼 호환성">
          <item>iOS/Android 양쪽 동작 확인</item>
          <item>다양한 화면 크기 지원 (태블릿 포함)</item>
          <item>권한 요청 적절성 (맥락 기반)</item>
          <item>플랫폼 가이드라인 준수 (Material/HIG)</item>
        </checklist>

        <checklist name="UI/UX 검증">
          <item>디자인 명세 일치</item>
          <item>터치 타겟 크기 (최소 48dp)</item>
          <item>로딩 상태 처리 (Shimmer/Skeleton)</item>
          <item>에러 상태 UI (재시도 제공)</item>
          <item>다크 모드 지원 (해당 시)</item>
        </checklist>
      </additional-checklists>
    </extend-phase>
  </phase-extensions>

  <!-- Mobile App 특화 에스컬레이션 규칙 -->
  <escalation-extensions>
    <rule trigger="UI/UX 불일치" route="tsq-designer" fallback="tsq-planner">
      화면 설계와 구현이 맞지 않으면 Designer에게 확인
    </rule>
    <rule trigger="플랫폼 호환성 이슈" route="tsq-developer">
      iOS/Android 분기 처리가 필요하면 Developer가 해결
    </rule>
    <rule trigger="성능 이슈" route="tsq-developer">
      프레임 드랍, 메모리 이슈 발생 시 Developer가 최적화
    </rule>
  </escalation-extensions>

  <!-- 배포 설정 -->
  <deployment>
    <environments>
      <env name="development" auto-deploy="true"/>
      <env name="staging" requires-review="true"/>
      <env name="production" requires-approval="true"/>
    </environments>

    <store-deploy>
      <ios>TestFlight → App Store Review → App Store</ios>
      <android>Internal Testing → Open Testing → Production</android>
    </store-deploy>

    <ci-cd>
      <provider>codemagic</provider>
      <checks>
        <check>analyze (dart analyze)</check>
        <check>format (dart format)</check>
        <check>unit-tests</check>
        <check>widget-tests</check>
        <check>build-android</check>
        <check>build-ios</check>
      </checks>
    </ci-cd>
  </deployment>
</workflow>
